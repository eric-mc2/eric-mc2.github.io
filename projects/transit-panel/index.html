<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Eric Chandler | Chicago Transit Ridership Panel</title>
  <meta name="description" content="Collecting a time series dataset for urban policy">

  
  
    <meta property="og:image" content="https://eric-mc2.github.io/img/headshot.png" />
    <meta property="og:title" content="Eric Chandler | Chicago Transit Ridership Panel" />   
  
  <meta property="og:description" content="Collecting a time series dataset for urban policy" />
  <meta name="author" content="Eric Chandler">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Saira+Extra+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Saira+Extra+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap"></noscript>
  <link rel="preload" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous"></noscript>
  
  <link rel="preload" href="https://eric-mc2.github.io/css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://eric-mc2.github.io/css/base.css"></noscript>
  <link rel="preload" href="https://eric-mc2.github.io/css/nav.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://eric-mc2.github.io/css/nav.css"></noscript> 
  <link rel="preload" href="https://eric-mc2.github.io/css/content.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://eric-mc2.github.io/css/content.css"></noscript>
    <link rel="preload" href="https://eric-mc2.github.io/css/tables.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript><link rel="stylesheet" href="https://eric-mc2.github.io/css/tables.css"></noscript>
  <link rel="preload" href="https://eric-mc2.github.io/css/tweaks.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://eric-mc2.github.io/css/tweaks.css"></noscript>
  <meta name="generator" content="Hugo 0.123.8">
  
    
    
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    
    
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>


    
  
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3XT6HHHNVY"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-3XT6HHHNVY', { 'anonymize_ip': false });
}
</script>

</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">Eric Chandler</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/headshot.png" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">About</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#education">Education</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#experience">Experience</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#projects">Projects</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#publications">Publications</a>
      </li>
      
      
    </ul>
  </div>
</nav>
  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="https://eric-mc2.github.io/">Eric Chandler</a>
</li>


<li class="breadcrumb-item">
  <a href="https://eric-mc2.github.io/projects/">Projects</a>
</li>


<li class="breadcrumb-item active">
  <a href="https://eric-mc2.github.io/projects/transit-panel/">Chicago Transit Ridership Panel</a>
</li>

  </ol>
</nav>




<section class="project-section p-3 p-lg-5 d-flex d-column">
  <div class="my-auto">
    <h1 class="mb-0"><span class="text-primary">Chicago Transit Ridership Panel</span></h1>
    <p>Project link: <a href="https://github.com/eric-mc2/DNCTransit">https://github.com/eric-mc2/DNCTransit</a></p>
    <p>This page describes the steps I took to create a panel dataset of ridership
across different Chicago transit systems. I did this to practice econometric modeling.</p>
<h1 id="transit-modes-and-data-sources">Transit modes and data sources</h1>
<p><strong>Included modes</strong></p>
<ul>
<li>Train, Bus, Rideshares - from the City of Chicago (used Socrata API and sodapy python package)</li>
<li>Bikeshares aka Divvy Bikes - from Lyft (used s3fs python package to access public Amazon S3 bucket)</li>
</ul>
<p><strong>Excluded modes</strong></p>
<ul>
<li>Metra commuter rail (public data is available but too coarsely aggregated)</li>
<li>Pace city-suburb bus link (have not checked availability)</li>
<li>Walking / Biking (vendored data is available &ndash; ie cell phone location data &ndash;
but would be hard to isolate from other transit modalities)</li>
<li>Driving (public data is available &ndash; ie road segment usage &ndash; but haven&rsquo;t seriously looked yet)</li>
</ul>
<p><strong>Extra data</strong></p>
<ul>
<li>Geographic boundaries - from US Census Bureau (used pygris python package)</li>
<li>Landmark boundaries - also from City of Chicago</li>
</ul>
<h1 id="etl-pipeline">ETL Pipeline</h1>
<p>Major steps in processing this data:</p>
<ol>
<li>Extract
<ol>
<li>Get raw unit-level data (i.e. train stations, bus lines)</li>
<li>Get raw ridership time series data</li>
</ol>
</li>
<li>Transform
<ol>
<li>Account for schema drift in each data source</li>
<li>Merge unit info and time series data</li>
<li>Compute and add covariates for regression</li>
</ol>
</li>
<li>Merge
<ol>
<li>Merge transit modalities at different spatial and time aggregations</li>
</ol>
</li>
<li>Choose
<ol>
<li>Choose best aggregation for regression modeling</li>
</ol>
</li>
</ol>
<h2 id="etl-illustration">ETL Illustration</h2>
<p>Some datasets were better organized than others. The easier ones only required:</p>
<ul>
<li>selecting spatial and time range to query</li>
<li>reading data documentation</li>
<li>figuring out which are the table primary and foreign keys</li>
<li>light conversion of data and object types</li>
</ul>
<p>In the simplest of cases, here&rsquo;s all the code we need to query and arrange a panel:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">src.data.cta</span> <span style="color:#007020;font-weight:bold">import</span> (ChiClient, 
</span></span><span style="display:flex;"><span>                          BUS_ROUTES_TABLE, 
</span></span><span style="display:flex;"><span>                          BUS_RIDERSHIP_TABLE)
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">src.data.gis</span> <span style="color:#007020;font-weight:bold">import</span> WORLD_CRS
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">shapely.geometry</span> <span style="color:#007020;font-weight:bold">import</span> shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># Query static info about bus routes</span>
</span></span><span style="display:flex;"><span>client <span style="color:#666">=</span> ChiClient(<span style="color:#40a070">60</span>)
</span></span><span style="display:flex;"><span>bus_routes <span style="color:#666">=</span>  client<span style="color:#666">.</span>get_all(BUS_ROUTES_TABLE, select<span style="color:#666">=</span><span style="color:#4070a0">&#34;the_geom, route, name&#34;</span>)
</span></span><span style="display:flex;"><span>bus_routes <span style="color:#666">=</span> (bus_routes
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>assign(geometry <span style="color:#666">=</span> bus_routes[<span style="color:#4070a0">&#39;the_geom&#39;</span>]<span style="color:#666">.</span>apply(shape))
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>drop(columns<span style="color:#666">=</span><span style="color:#4070a0">&#39;the_geom&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>pipe(gpd<span style="color:#666">.</span>GeoDataFrame, crs<span style="color:#666">=</span>WORLD_CRS))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># Query daily rides per route</span>
</span></span><span style="display:flex;"><span>data_start <span style="color:#666">=</span> <span style="color:#4070a0">&#34;2024-01-01T00:00:00&#34;</span>
</span></span><span style="display:flex;"><span>data_end <span style="color:#666">=</span> <span style="color:#4070a0">&#34;2024-08-31T23:59:59&#34;</span>
</span></span><span style="display:flex;"><span>bus_rides <span style="color:#666">=</span> client<span style="color:#666">.</span>get_all(BUS_RIDERSHIP_TABLE, 
</span></span><span style="display:flex;"><span>                            select<span style="color:#666">=</span><span style="color:#4070a0">&#34;route,date,daytype,rides&#34;</span>,
</span></span><span style="display:flex;"><span>                            where<span style="color:#666">=</span><span style="color:#4070a0">f</span><span style="color:#4070a0">&#34;date between &#39;</span><span style="color:#70a0d0">{</span>data_start<span style="color:#70a0d0">}</span><span style="color:#4070a0">&#39; and &#39;</span><span style="color:#70a0d0">{</span>data_end<span style="color:#70a0d0">}</span><span style="color:#4070a0">&#39;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bus_panel <span style="color:#666">=</span> bus_rides<span style="color:#666">.</span>merge(bus_routes, how<span style="color:#666">=</span><span style="color:#4070a0">&#39;left&#39;</span>, on<span style="color:#666">=</span><span style="color:#4070a0">&#39;route&#39;</span>)
</span></span></code></pre></div><p>Let&rsquo;s plot these routes, colored by ridership:</p>


<div id="/json/bus-route-rides.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/bus-route-rides.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/bus-route-rides.json"));
</script>
<p>After getting the direct transit data, I coded a few extra features such as
census tract and population, which could serve as useful regression controls later on.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pygris</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#60a0b0;font-style:italic"># CTA routes extend outside chicago into cook cty.</span>
</span></span><span style="display:flex;"><span>tracts <span style="color:#666">=</span> pygris<span style="color:#666">.</span>tracts(state<span style="color:#666">=</span><span style="color:#4070a0">&#39;IL&#39;</span>, county<span style="color:#666">=</span><span style="color:#4070a0">&#39;cook&#39;</span>, cb<span style="color:#666">=</span><span style="color:#007020;font-weight:bold">True</span>, year<span style="color:#666">=</span><span style="color:#40a070">2020</span>, cache<span style="color:#666">=</span><span style="color:#007020;font-weight:bold">False</span>)
</span></span><span style="display:flex;"><span>tracts <span style="color:#666">=</span> tracts[[<span style="color:#4070a0">&#39;GEOID&#39;</span>,<span style="color:#4070a0">&#39;geometry&#39;</span>]]
</span></span><span style="display:flex;"><span>tracts[<span style="color:#4070a0">&#39;GEOID&#39;</span>] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_numeric(tracts[<span style="color:#4070a0">&#39;GEOID&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">code_tract</span>(gdf, tracts_gdf) <span style="color:#666">-&gt;</span> pd<span style="color:#666">.</span>Series:
</span></span><span style="display:flex;"><span>    <span style="color:#4070a0">&#34;&#34;&#34;Spatial join points to census tract&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    codes <span style="color:#666">=</span> (gdf
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>filter([<span style="color:#4070a0">&#39;geometry&#39;</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>to_crs(tracts_gdf<span style="color:#666">.</span>crs)
</span></span><span style="display:flex;"><span>            <span style="color:#666">.</span>sjoin(tracts_gdf, how<span style="color:#666">=</span><span style="color:#4070a0">&#39;left&#39;</span>, predicate<span style="color:#666">=</span><span style="color:#4070a0">&#39;within&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> pd<span style="color:#666">.</span>concat([gdf, codes[<span style="color:#4070a0">&#39;GEOID&#39;</span>]<span style="color:#666">.</span>rename(<span style="color:#4070a0">&#39;tract&#39;</span>), axis<span style="color:#666">=</span><span style="color:#40a070">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bus_stops <span style="color:#666">=</span> bus_stops<span style="color:#666">.</span>pipe(code_tract)
</span></span></code></pre></div><p>Now we know the immediate population served by each bus line.</p>


<div id="/json/bus-route-pop.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/bus-route-pop.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/bus-route-pop.json"));
</script>
<p>Since ridership is reported at different levels of granularity for each transit modality, I had to be careful how to spatially aggregate the data. My goal is to test whether local events, such as football games, have a measurable effect on transit. Associating transit stations to points of interest is straightforward &ndash; each point is an unambiguous distance away. Associating shapes such as bus routes or census tracts is more ambiguous &ndash; do we measure the distance to the closest bus stop or the furthest? The data doesn&rsquo;t tell us whether riders travel short or far distances along these routes. This ambiguity can create inaccurate regression estimates.</p>
<p>
  <img src="/img/point-line-dist.jpeg" alt="Distance to point-of-interest">
</p>
<ul>
<li>Train: provides daily boarding counts per station. we do not know where each passenger exited, nor which direction or train route they took.</li>
<li>Bus: provides daily boardings counts per route. we do not know how this breaks down per bus stop, nor the direction or stop passengers exited at.</li>
<li>Bike: provides trip-level data: timestamped station pickups and dropoffs per ride.</li>
<li>Bike: provides trip-level data: timestamped pickup and dropoffs per ride. pickup and dropoff points are anonymized to their containing census tract.</li>
</ul>
<table>
<thead>
<tr>
<th>Modality</th>
<th>Train</th>
<th>Bus</th>
<th>Bike</th>
<th>Uber</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Time granularity</strong></td>
<td>Daily</td>
<td>Daily</td>
<td>Minute</td>
<td>Minute</td>
</tr>
<tr>
<td><strong>Direction of travel</strong></td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><strong>Point of departure</strong></td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><strong>Line of departure</strong></td>
<td>Inferred</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><strong>Area of departure</strong></td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><strong>Point of arrival</strong></td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td><strong>Line of arrival</strong></td>
<td>Inferred</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><strong>Area of arrival</strong></td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<!-- raw HTML omitted -->
<p>I aggregated three comparable panels:</p>
<ul>
<li>Point: train, bike</li>
<li>Line: train, bus</li>
<li>Area: train, bike, uber</li>
</ul>


<div id="/json/tracts-viz.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/tracts-viz.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/tracts-viz.json"));
</script>
<h2 id="special-challenges">Special Challenges</h2>
<h3 id="divvy-locations">Divvy Locations</h3>
<p>The divvy historical data spans from 2013 to 2024. Over these years, the published
schema has changed several times. This led to annoying, but forgiveable issues
to work around:</p>
<p><em>Batch Size:</em> Some years are published in monthly batches, others quarterly.
This isn&rsquo;t an issue for data modeling, since we just concatenate, but it requires
extra logic for properly discovering and enumerating the available data.</p>
<p><em>Inconsistent column names:</em> Also not an issue for modeling, since I just rename them,
but requires manually curating a mapping of {old name -&gt; new name} .</p>
<p><em>Normalized vs Denormalized:</em> Some years contain data in &ldquo;database normalized&rdquo;
format with separate stations and rides tables, linked by a common station_id key.
Other years only contain a single de-normalized/merged rides table, with station info included.</p>
<p>But the divvy data contained two way worse problems:</p>
<p><strong>Unstable station id&rsquo;s</strong></p>
<p>In some batches, the station ID is an integer, while in others it is a UUID,
representing schema drift. This drift broke the one-to-one property of station IDs:
60% of station IDs were one-to-many: they were associated with up to 4 unique stations.</p>
<p>
  <img src="/img/id-to-name.jpeg" alt="Non-unique IDs">
</p>
<p>For those not familiar with Chicago streets, these intersections are quite far apart:</p>


<div id="/json/bike-id-name.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/bike-id-name.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/bike-id-name.json"));
</script>
<p>The standard approach to resolving this issue is to create a column labeling each observation with
the batch it came from (eg. &ldquo;2024-Q1&rdquo;) and use (ID, batch) pairs as the new primary key.
Although this fixes the one-to-many issue, it breaks the injective property of station IDs,
making them many-to-one!</p>
<p>
  <img src="/img/id-batch-to-name.jpeg" alt="Non-unique IDs">
</p>
<p><strong>Unstable station name</strong></p>
<p>Looking at the data this way, perhaps the station name is a sufficient primary key?</p>
<p>Unfortunately, station names were also not always one-to-one. For example, the following
locations are all purportedly at Buckingham Fountain:</p>


<div id="/json/buckingham.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/buckingham.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/buckingham.json"));
</script>
<p>Similarly, station names were also not always injective.</p>
<p><strong>Imprecise station locations</strong></p>
<p>Recent Divvy historical data batches are published as single denormalized CSV&rsquo;s
containing trip_start_location and trip_end_location geometries.
Maybe the points can be our primary keys?</p>
<p>At first glance, there are some ~900,000 unique points. At MOST I should expect a few thousand!</p>
<p>Maybe this is a floating point precision issue and the points are actually
well-clustered around their true station locations. Maybe I can derive a much
smaller set of representative locations and snap each point to the closest one.</p>
<p><em>Attribute Group-By</em>: I group by attribute (e.g. name, id, batch), compute the
centroid of each group, and measure the maximum point-to-centroid distance per group.
This quantifies the spread or imprecision in using names, ids, batches as primary keys
to actually identify station locations.</p>
<p>In code this would look something like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>TOLERANCE <span style="color:#666">=</span> <span style="color:#40a070">1320</span>  <span style="color:#60a0b0;font-style:italic"># feet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">dispersion</span>(x: gpd<span style="color:#666">.</span>GeoSeries, metric: Callable <span style="color:#666">=</span> np<span style="color:#666">.</span>std):
</span></span><span style="display:flex;"><span>    <span style="color:#60a0b0;font-style:italic"># Taking centroid of unique points makes us more sensitive to outlier mis-labeled data when</span>
</span></span><span style="display:flex;"><span>    <span style="color:#60a0b0;font-style:italic"># using standard deviation as metric. When using max it makes no difference.</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#666">=</span> x<span style="color:#666">.</span>drop_duplicates()
</span></span><span style="display:flex;"><span>    c <span style="color:#666">=</span> MultiPoint(x<span style="color:#666">.</span>values)<span style="color:#666">.</span>centroid
</span></span><span style="display:flex;"><span>    radius <span style="color:#666">=</span> metric(x<span style="color:#666">.</span>distance(c))
</span></span><span style="display:flex;"><span>    diam <span style="color:#666">=</span> radius <span style="color:#666">*</span> <span style="color:#40a070">2</span>  <span style="color:#60a0b0;font-style:italic"># very rough</span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">return</span> diam
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_spread <span style="color:#666">=</span> bike_rides<span style="color:#666">.</span>to_crs(LOCAL_CRS)
</span></span><span style="display:flex;"><span>    <span style="color:#666">.</span>groupby(<span style="color:#4070a0">&#39;name&#39;</span>)[<span style="color:#4070a0">&#39;geometry&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#666">.</span>transform(<span style="color:#007020;font-weight:bold">lambda</span> x: dispersion(x, np<span style="color:#666">.</span>max))
</span></span><span style="display:flex;"><span>clusterable <span style="color:#666">=</span> max_spread <span style="color:#666">&lt;</span> TOLERANCE
</span></span></code></pre></div><p>Based on this method, ~106,000 points can be reduced down to ~1,00 representative
points, but the remaining ~786,000 points are too dispersed to confidently say
the refer to the same point.</p>
<!-- raw HTML omitted -->


<div id="/json/bike-clusters.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/bike-clusters.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/bike-clusters.json"));
</script>
<p><em>Spatial Clustering</em>:
As seen above, these ID columns are not necessarly bijective, meaning they are
over-specified. Maybe I should group the points purely by their location, and
ignore their IDs.</p>
<p>There are many ways to cluster points. I&rsquo;ll use an intuitive way as follows:</p>
<ol>
<li>Draw a buffer around each point (66ft is the typical Chicago <a href="https://www.chicago.gov/dam/city/depts/cdot/StreetandSitePlanDesignStandards407.pdf">street width</a>)</li>
<li>Find all buffers that intersect (via unary union)
<ol>
<li>Each unioned buffer shape represents a candidate cluster</li>
<li>Build spatial index on these clusters</li>
</ol>
</li>
<li>For each point, determine which cluster it belongs to (via spatial index query)</li>
<li>Break apart clusters that are:
<ol>
<li>Too dispersed</li>
<li>Have heterogenous attributes (e.g. station names)</li>
</ol>
</li>
</ol>
<p>This method affirms the outcome of the attribute clustering performed above. The
20% of data that is tightly spatially grouped do indeed represent unique stations.
The other 80% of the data can be unioned into clusters that contain up to 7818
points.</p>
<p>The buffer union method suffers from a transitivity issue:</p>
$$
\text{dist}(A,B) < d, \text{dist}(B,C) < d \not \Rightarrow \text{dist}(A,C) < d
$$
<p>We can see that step 5 helps mitigate this issue.</p>


<div id="/json/bike-spatial-cluster.json" class="leaflet" style="height:500px;"></div>
<script type="module">
    import { plot as leafletcustomplot} from "/js/leaflet_custom.js";
    fetch("/json/bike-spatial-cluster.json")
        .then(response => response.json())
        .then(fig => leafletcustomplot(fig, "\/json\/bike-spatial-cluster.json"));
</script>
<p>I have to conclude that these points actually represent user locations when
they start/stop trips on their smartphone apps. The drift represents a combination
of GPS uncertainty among tall downtown buildings, and physical user displacement
from the actual station when they interact with the app.</p>
<p><strong>Resolution with GBFS</strong></p>
<p>As a last resort, I looked at and decided to merge the live GBFS feed. This
dataset is intended for app developers, and shows real-time station availability
and such. The problem is it&rsquo;s live and doesn&rsquo;t span the entire historical data range.
Given the schema drift issues presented above, I had no confidence the data was
merge-able with anything but 2024 data. But since I only strictly need 2024 data for
the models I plan to run, this limitation is acceptable.</p>
<p><em>Problem solved!</em></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="socrata-to-data-frames">Socrata to Data Frames</h3>
<p>As far as I could tell, the Socrata SoQL API returned all data as lists of lists of strings. Since I was making a lot of Socrata calls, I extended the Socrata client like so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">sodapy</span> <span style="color:#007020;font-weight:bold">import</span> Socrata
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">pandas</span> <span style="color:#007020;font-weight:bold">as</span> <span style="color:#0e84b5;font-weight:bold">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">ChiClient</span>(Socrata):
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">def</span> __init__(self, timeout: <span style="color:#007020">int</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#007020">super</span>()<span style="color:#666">.</span>__init__(
</span></span><span style="display:flex;"><span>            <span style="color:#4070a0">&#34;data.cityofchicago.org&#34;</span>, 
</span></span><span style="display:flex;"><span>            app_token<span style="color:#666">=</span><span style="color:#007020;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>            timeout<span style="color:#666">=</span>timeout)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">get</span>(self, 
</span></span><span style="display:flex;"><span>            resource_id: <span style="color:#007020">str</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#666">**</span>params) <span style="color:#666">-&gt;</span> pd<span style="color:#666">.</span>DataFrame:
</span></span><span style="display:flex;"><span>        <span style="color:#4070a0">&#34;&#34;&#34;Collects Socrata response into data frame.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#666">=</span> <span style="color:#007020">super</span>()<span style="color:#666">.</span>get(resource_id, <span style="color:#666">**</span>params)
</span></span><span style="display:flex;"><span>        df <span style="color:#666">=</span> pd<span style="color:#666">.</span>DataFrame<span style="color:#666">.</span>from_records(data)
</span></span><span style="display:flex;"><span>        df <span style="color:#666">=</span> self<span style="color:#666">.</span>fix_coltypes(df, resource_id)
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">fix_coltypes</span>(self, df: pd<span style="color:#666">.</span>DataFrame, resource_id: <span style="color:#007020">str</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#4070a0">&#34;&#34;&#34;Coerce string data into other dtypes&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#666">=</span> self<span style="color:#666">.</span>get_coltypes(resource_id)
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">for</span> col <span style="color:#007020;font-weight:bold">in</span> df<span style="color:#666">.</span>columns:
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">if</span> col <span style="color:#007020;font-weight:bold">not</span> <span style="color:#007020;font-weight:bold">in</span> coltypes<span style="color:#666">.</span>keys():
</span></span><span style="display:flex;"><span>                <span style="color:#60a0b0;font-style:italic"># Column was transformed e.g. SELECT COUNT(col)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#60a0b0;font-style:italic"># or renamed e.g. SELECT col AS alias</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007020;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">elif</span> coltypes[col] <span style="color:#666">==</span> <span style="color:#4070a0">&#39;calendar_date&#39;</span>:
</span></span><span style="display:flex;"><span>                df[col] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_datetime(df[col])
</span></span><span style="display:flex;"><span>            <span style="color:#007020;font-weight:bold">elif</span> coltypes[col] <span style="color:#666">==</span> <span style="color:#4070a0">&#39;number&#39;</span>:
</span></span><span style="display:flex;"><span>                df[col] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_numeric(df[col])
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">get_coltypes</span>(self, resource_id: <span style="color:#007020">str</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#4070a0">&#34;&#34;&#34;Query basic table metadata&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        meta <span style="color:#666">=</span> self<span style="color:#666">.</span>get_metadata(resource_id)
</span></span><span style="display:flex;"><span>        colnames <span style="color:#666">=</span> [c[<span style="color:#4070a0">&#39;fieldName&#39;</span>] <span style="color:#007020;font-weight:bold">for</span> c <span style="color:#007020;font-weight:bold">in</span> meta[<span style="color:#4070a0">&#39;columns&#39;</span>]]
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#666">=</span> [c[<span style="color:#4070a0">&#39;dataTypeName&#39;</span>] <span style="color:#007020;font-weight:bold">for</span> c <span style="color:#007020;font-weight:bold">in</span> meta[<span style="color:#4070a0">&#39;columns&#39;</span>]]
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#666">=</span> {c: ct <span style="color:#007020;font-weight:bold">for</span> c,ct <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020">zip</span>(colnames, coltypes)}
</span></span><span style="display:flex;"><span>        <span style="color:#007020;font-weight:bold">return</span> coltypes
</span></span></code></pre></div><p>Usage comparison:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>In <span style="color:#666">[</span>1<span style="color:#666">]</span>: <span style="color:#bb60d5">TOTAL_RIDERSHIP_TABLE</span> <span style="color:#666">=</span> <span style="color:#4070a0">&#34;6iiy-9s97&#34;</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>2<span style="color:#666">]</span>: <span style="color:#bb60d5">soc_client</span> <span style="color:#666">=</span> Socrata<span style="color:#666">(</span><span style="color:#4070a0">&#34;data.cityofchicago.org&#34;</span>, <span style="color:#bb60d5">app_token</span><span style="color:#666">=</span>None, <span style="color:#bb60d5">timeout</span><span style="color:#666">=</span>60<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>3<span style="color:#666">]</span>: <span style="color:#bb60d5">chi_client</span> <span style="color:#666">=</span> ChiClient<span style="color:#666">(</span>60<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>4<span style="color:#666">]</span>: <span style="color:#bb60d5">original_data</span> <span style="color:#666">=</span> soc_client.get<span style="color:#666">(</span>TOTAL_RIDERSHIP_TABLE, <span style="color:#bb60d5">limit</span><span style="color:#666">=</span>5<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>5<span style="color:#666">]</span>: <span style="color:#bb60d5">pretty_data</span> <span style="color:#666">=</span> chi_client.get<span style="color:#666">(</span>TOTAL_RIDERSHIP_TABLE, <span style="color:#bb60d5">limit</span><span style="color:#666">=</span>5<span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>6<span style="color:#666">]</span>: print<span style="color:#666">(</span><span style="color:#4070a0">&#34;Original response:&#34;</span>, original_data, <span style="color:#bb60d5">sep</span><span style="color:#666">=</span><span style="color:#4070a0">&#34;\n&#34;</span><span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>Original response:
</span></span><span style="display:flex;"><span><span style="color:#666">[{</span><span style="color:#4070a0">&#39;service_date&#39;</span>: <span style="color:#4070a0">&#39;2001-01-01T00:00:00.000&#39;</span>, <span style="color:#4070a0">&#39;day_type&#39;</span>: <span style="color:#4070a0">&#39;U&#39;</span>, <span style="color:#4070a0">&#39;bus&#39;</span>: <span style="color:#4070a0">&#39;297192&#39;</span>, <span style="color:#4070a0">&#39;rail_boardings&#39;</span>: <span style="color:#4070a0">&#39;126455&#39;</span>, <span style="color:#4070a0">&#39;total_rides&#39;</span>: <span style="color:#4070a0">&#39;423647&#39;</span><span style="color:#666">}</span>, <span style="color:#666">{</span><span style="color:#4070a0">&#39;service_date&#39;</span>: <span style="color:#4070a0">&#39;2001-01-02T00:00:00.000&#39;</span>, <span style="color:#4070a0">&#39;day_type&#39;</span>: <span style="color:#4070a0">&#39;W&#39;</span>, <span style="color:#4070a0">&#39;bus&#39;</span>: <span style="color:#4070a0">&#39;780827&#39;</span>, <span style="color:#4070a0">&#39;rail_boardings&#39;</span>: <span style="color:#4070a0">&#39;501952&#39;</span>, <span style="color:#4070a0">&#39;total_rides&#39;</span>: <span style="color:#4070a0">&#39;1282779&#39;</span><span style="color:#666">}</span>, <span style="color:#666">{</span><span style="color:#4070a0">&#39;service_date&#39;</span>: <span style="color:#4070a0">&#39;2001-01-03T00:00:00.000&#39;</span>, <span style="color:#4070a0">&#39;day_type&#39;</span>: <span style="color:#4070a0">&#39;W&#39;</span>, <span style="color:#4070a0">&#39;bus&#39;</span>: <span style="color:#4070a0">&#39;824923&#39;</span>, <span style="color:#4070a0">&#39;rail_boardings&#39;</span>: <span style="color:#4070a0">&#39;536432&#39;</span>, <span style="color:#4070a0">&#39;total_rides&#39;</span>: <span style="color:#4070a0">&#39;1361355&#39;</span><span style="color:#666">}</span>, <span style="color:#666">{</span><span style="color:#4070a0">&#39;service_date&#39;</span>: <span style="color:#4070a0">&#39;2001-01-04T00:00:00.000&#39;</span>, <span style="color:#4070a0">&#39;day_type&#39;</span>: <span style="color:#4070a0">&#39;W&#39;</span>, <span style="color:#4070a0">&#39;bus&#39;</span>: <span style="color:#4070a0">&#39;870021&#39;</span>, <span style="color:#4070a0">&#39;rail_boardings&#39;</span>: <span style="color:#4070a0">&#39;550011&#39;</span>, <span style="color:#4070a0">&#39;total_rides&#39;</span>: <span style="color:#4070a0">&#39;1420032&#39;</span><span style="color:#666">}</span>, <span style="color:#666">{</span><span style="color:#4070a0">&#39;service_date&#39;</span>: <span style="color:#4070a0">&#39;2001-01-05T00:00:00.000&#39;</span>, <span style="color:#4070a0">&#39;day_type&#39;</span>: <span style="color:#4070a0">&#39;W&#39;</span>, <span style="color:#4070a0">&#39;bus&#39;</span>: <span style="color:#4070a0">&#39;890426&#39;</span>, <span style="color:#4070a0">&#39;rail_boardings&#39;</span>: <span style="color:#4070a0">&#39;557917&#39;</span>, <span style="color:#4070a0">&#39;total_rides&#39;</span>: <span style="color:#4070a0">&#39;1448343&#39;</span><span style="color:#666">}]</span>
</span></span><span style="display:flex;"><span>In <span style="color:#666">[</span>7<span style="color:#666">]</span>: print<span style="color:#666">(</span><span style="color:#4070a0">&#34;DataFrame response:&#34;</span>, pretty_data, <span style="color:#bb60d5">sep</span><span style="color:#666">=</span><span style="color:#4070a0">&#34;\n&#34;</span><span style="color:#666">)</span>
</span></span><span style="display:flex;"><span>DataFrame response:
</span></span><span style="display:flex;"><span>  service_date day_type     bus  rail_boardings  total_rides
</span></span><span style="display:flex;"><span><span style="color:#40a070">0</span>   2001-01-01        U  <span style="color:#40a070">297192</span>          <span style="color:#40a070">126455</span>       <span style="color:#40a070">423647</span>
</span></span><span style="display:flex;"><span><span style="color:#40a070">1</span>   2001-01-02        W  <span style="color:#40a070">780827</span>          <span style="color:#40a070">501952</span>      <span style="color:#40a070">1282779</span>
</span></span><span style="display:flex;"><span><span style="color:#40a070">2</span>   2001-01-03        W  <span style="color:#40a070">824923</span>          <span style="color:#40a070">536432</span>      <span style="color:#40a070">1361355</span>
</span></span><span style="display:flex;"><span><span style="color:#40a070">3</span>   2001-01-04        W  <span style="color:#40a070">870021</span>          <span style="color:#40a070">550011</span>      <span style="color:#40a070">1420032</span>
</span></span><span style="display:flex;"><span><span style="color:#40a070">4</span>   2001-01-05        W  <span style="color:#40a070">890426</span>          <span style="color:#40a070">557917</span>      <span style="color:#40a070">1448343</span>
</span></span></code></pre></div>
    <ul class="tags">
    
      <li><a class="tag" href="/tags/data-science">data science</a></li>
    
      <li><a class="tag" href="/tags/open-data">open data</a></li>
    
      <li><a class="tag" href="/tags/urban-science">urban science</a></li>
    
      <li><a class="tag" href="/tags/socrata">Socrata</a></li>
    
      <li><a class="tag" href="/tags/amazon-s3">Amazon S3</a></li>
    
      <li><a class="tag" href="/tags/geopandas">geopandas</a></li>
    
</ul>

  </div>
</section>

    <section><span style="color: #999999;">Nifty <a href="https://codepen.io/wbeeftink/pen/dIaDH">tech tag lists</a> from <a class="pen-owner-link" href="https://codepen.io/wbeeftink">Wouter Beeftink</a> </span>
      
    </section>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.4.slim.min.js" integrity="sha256-a2yjHM4jnF9f54xUQakjZGaqYs/V1CYvWpoqZzC2/Bw=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  
  <script src="https://unpkg.com/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js" integrity="sha384-EYn4rWu1DHvYD0sSSSbMEtXQmMl58CFJd897806+RT1jJVYbhuZlZMN6yG9nCyFa" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/smoothscroll-anchor-polyfill@1.3.2/dist/index.min.js" integrity="sha384-EY9NBEHCFbZANmPcTm7CgG8OhsFILy0VBLG85pF6OIpP42NVbZVNsFOc23PYTCkB" crossorigin="anonymous"></script>
  
  <script async src="/js/resume.js"></script>
  
  

  
  
</body>
</html>
