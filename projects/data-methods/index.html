<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Eric Chandler | </title>
  <meta name="description" content="">

  
  
    <meta property="og:image" content="http://localhost:1313/img/headshot.png" />
    <meta property="og:title" content="Eric Chandler | " />   
  
  <meta property="og:description" content="" />
  <meta name="author" content="Eric Chandler">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Saira+Extra+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Saira+Extra+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap"></noscript>
  <link rel="preload" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous"></noscript>
  
  <link rel="preload" href="http://localhost:1313/css/base.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/css/base.css"></noscript>
  <link rel="preload" href="http://localhost:1313/css/nav.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/css/nav.css"></noscript> 
  <link rel="preload" href="http://localhost:1313/css/content.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/css/content.css"></noscript>
  <link rel="preload" href="http://localhost:1313/css/tweaks.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="http://localhost:1313/css/tweaks.css"></noscript>
  <meta name="generator" content="Hugo 0.123.8">
  
   
  
</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">Eric Chandler</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/headshot.png" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">About</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#education">Education</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#experience">Experience</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#projects">Projects</a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#publications">Publications</a>
      </li>
      
      
    </ul>
  </div>
</nav>
  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="http://localhost:1313/">Eric Chandler</a>
</li>


<li class="breadcrumb-item">
  <a href="http://localhost:1313/projects/">Projects</a>
</li>


<li class="breadcrumb-item active">
  <a href="http://localhost:1313/projects/data-methods/"></a>
</li>

  </ol>
</nav>




<section class="resume-section p-3 p-lg-5 d-flex d-column">
  <div class="my-auto">
    <h2 class="mb-0"><span class="text-primary"></span></h2>
    <h1 id="creating-a-chicago-transit-panel-dataset">Creating a Chicago Transit Panel Dataset</h1>
<p>This blog post describes the steps I took to create a panel dataset of ridership
across different Chicago transit systems. The dataset is part of a side-project
to practice creating econometric models such as &ldquo;what is the impact of Nascar
road closures on transit patterns?&rdquo;</p>
<h1 id="transit-modes-and-data-sources">Transit modes and data sources</h1>
<p><strong>Included modes</strong></p>
<ul>
<li>Train, Bus, Rideshares - from the City of Chicago (used Socrata API and sodapy python package)</li>
<li>Bikeshares aka Divvy Bikes - from Lyft (used s3fs python package to access public Amazon S3 bucket)</li>
</ul>
<p><strong>Excluded modes</strong></p>
<ul>
<li>Metra commuter rail (public data is available but too coarsely aggregated)</li>
<li>Pace city-suburb bus link (have not checked availability)</li>
<li>Walking / Biking (vendored data is available &ndash; ie cell phone location data &ndash;
but would be hard to isolate from other transit modalities)</li>
<li>Driving (public data is available &ndash; ie road segment usage &ndash; but haven&rsquo;t seriously looked yet)</li>
</ul>
<p><strong>Extra data</strong></p>
<ul>
<li>Geographic boundaries - from US Census Bureau (used pygris python package)</li>
<li>Landmark boundaries - also from City of Chicago</li>
</ul>
<h1 id="etl-pipeline">ETL Pipeline</h1>
<p>Major steps in processing this data:</p>
<ol>
<li>Extract
<!-- raw HTML omitted -->
</li>
<li>Transform
<!-- raw HTML omitted -->
</li>
<li>Merge
<!-- raw HTML omitted -->
</li>
<li>Choose
<!-- raw HTML omitted -->
</li>
</ol>
<h2 id="etl-illustration">ETL Illustration</h2>
<p>Some datasets were better organized than others. The easier ones only required:</p>
<ul>
<li>selecting spatial and time range to query</li>
<li>reading data documentation</li>
<li>figuring out which are the table primary and foreign keys</li>
<li>light conversion of data and object types</li>
</ul>
<p>That code wasn&rsquo;t much more involved than:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> src.data.cta <span style="color:#f92672">import</span> (ChiClient, 
</span></span><span style="display:flex;"><span>                        BUS_ROUTES_TABLE, 
</span></span><span style="display:flex;"><span>                        BUS_RIDERSHIP_TABLE)
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> src.data.gis <span style="color:#f92672">import</span> WORLD_CRS
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> shapely.geometry <span style="color:#f92672">import</span> shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Query static info about bus routes</span>
</span></span><span style="display:flex;"><span>client <span style="color:#f92672">=</span> ChiClient(<span style="color:#ae81ff">60</span>)
</span></span><span style="display:flex;"><span>bus_routes <span style="color:#f92672">=</span>  client<span style="color:#f92672">.</span>get_all(BUS_ROUTES_TABLE, select<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;the_geom, route, name&#34;</span>)
</span></span><span style="display:flex;"><span>bus_routes <span style="color:#f92672">=</span> (bus_routes
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>assign(geometry <span style="color:#f92672">=</span> bus_routes[<span style="color:#e6db74">&#39;the_geom&#39;</span>]<span style="color:#f92672">.</span>apply(shape))
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>drop(columns<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;the_geom&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>pipe(gpd<span style="color:#f92672">.</span>GeoDataFrame, crs<span style="color:#f92672">=</span>WORLD_CRS))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Query daily rides per route</span>
</span></span><span style="display:flex;"><span>data_start <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2024-01-01T00:00:00&#34;</span>
</span></span><span style="display:flex;"><span>data_end <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2024-08-31T23:59:59&#34;</span>
</span></span><span style="display:flex;"><span>bus_rides <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>get_all(BUS_RIDERSHIP_TABLE, 
</span></span><span style="display:flex;"><span>                            select<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;route,date,daytype,rides&#34;</span>,
</span></span><span style="display:flex;"><span>                            where<span style="color:#f92672">=</span><span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;date between &#39;</span><span style="color:#e6db74">{</span>data_start<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39; and &#39;</span><span style="color:#e6db74">{</span>data_end<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</span></span></code></pre></div><p>TODO: Add some viz here.</p>
<p>I added features like census tract:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pygris
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CTA routes extend outside chicago into cook cty.</span>
</span></span><span style="display:flex;"><span>tracts <span style="color:#f92672">=</span> pygris<span style="color:#f92672">.</span>tracts(state<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;IL&#39;</span>, county<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;cook&#39;</span>, cb<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, year<span style="color:#f92672">=</span><span style="color:#ae81ff">2020</span>, cache<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>tracts <span style="color:#f92672">=</span> tracts[[<span style="color:#e6db74">&#39;GEOID&#39;</span>,<span style="color:#e6db74">&#39;geometry&#39;</span>]]
</span></span><span style="display:flex;"><span>tracts[<span style="color:#e6db74">&#39;GEOID&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(tracts[<span style="color:#e6db74">&#39;GEOID&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">code_tract</span>(gdf, tracts_gdf) <span style="color:#f92672">-&gt;</span> pd<span style="color:#f92672">.</span>Series:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Spatial join points to census tract&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    codes <span style="color:#f92672">=</span> (gdf
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>filter([<span style="color:#e6db74">&#39;geometry&#39;</span>])
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>to_crs(tracts_gdf<span style="color:#f92672">.</span>crs)
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>sjoin(tracts_gdf, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;left&#39;</span>, predicate<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;within&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pd<span style="color:#f92672">.</span>concat([gdf, codes[<span style="color:#e6db74">&#39;GEOID&#39;</span>]<span style="color:#f92672">.</span>rename(<span style="color:#e6db74">&#39;tract&#39;</span>), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>bus_stops <span style="color:#f92672">=</span> bus_stops<span style="color:#f92672">.</span>pipe(code_tract)
</span></span></code></pre></div><p>Since ridership is reported at different levels of granularity for each transit modality, I had to be careful how to spatially aggregate the data. My goal is to test whether local events, such as football games, have a measurable effect on transit. Associating transit stations to points of interest is straightforward &ndash; each point is an unambiguous distance away. Associating shapes such as bus routes or census tracts is more ambiguous &ndash; do we measure the distance to the closest bus stop or the furthest? The data doesn&rsquo;t tell us whether riders travel short or far distances along these routes. This ambiguity can create inaccurate regression estimates.</p>
<p>TODO: Picture?</p>
<ul>
<li>Train: provides daily boarding counts per station. we do not know where each passenger exited, nor which direction or train route they took.</li>
<li>Bus: provides daily boardings counts per route. we do not know how this breaks down per bus stop, nor the direction or stop passengers exited at.</li>
<li>Bike: provides trip-level data: timestamped station pickups and dropoffs per ride.</li>
<li>Bike: provides trip-level data: timestamped pickup and dropoffs per ride. pickup and dropoff points are anonymized to their containing census tract.</li>
</ul>
<table>
<thead>
<tr>
<th>Modality</th>
<th>Train</th>
<th>Bus</th>
<th>Bike</th>
<th>Uber</th>
</tr>
</thead>
<tbody>
<tr>
<td>Time granularity</td>
<td>Daily</td>
<td>Daily</td>
<td>Minute</td>
<td>Minute</td>
</tr>
<tr>
<td>Direction of travel</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Point of departure</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Line of departure</td>
<td>Inferred</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Area of departure</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Point of arrival</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>Line of arrival</td>
<td>Inferred</td>
<td>Yes</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Area of arrival</td>
<td>Yes</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>I aggregated three comparable panels:</p>
<ul>
<li>Point: train, bike</li>
<li>Line: train, bus</li>
<li>Area: train, bike, uber</li>
</ul>
<p>TODO: For fun, here is a map of ridership over time!</p>
<h2 id="special-challenges">Special Challenges</h2>
<h3 id="divvy-locations">Divvy Locations</h3>
<p>The divvy historical data spans from xxx to xxxx. Over these years, the published
schema has changed several times. This led to annoying, but forgiveable issues
to work around:</p>
<p><em>Batch Size:</em> Some years are published in monthly batches, others quarterly.
This isn&rsquo;t an issue for data modeling, since we just concatenate, but it requires
extra logic for properly discovering and enumerating the available data.</p>
<p><em>Inconsistent column names:</em> Also not an issue for modeling, since I just rename them,
but requires manually curating a mapping of {old name -&gt; new name} .</p>
<p><em>Normalized vs Denormalized:</em> Some years contain data in &ldquo;database normalized&rdquo;
format with separate stations and rides tables, linked by a common station_id key.
Other years only contain a single de-normalized/merged rides table, with station info included.</p>
<p>But the divvy data contained two way worse problems:</p>
<p><strong>Unstable station id&rsquo;s</strong></p>
<p>In some batches, the station ID is an integer, while in others it is a UUID, and
ID values do not uniquely identify a station.</p>
<p>TODO: map of all stations with ID = 5</p>
<p>The standard approach to resolving this issue is to create a column labeling each observation with
the batch it came from (eg. &ldquo;2024-Q1&rdquo;) and use (ID, batch) pairs as the new primary key.
<em>This still didn&rsquo;t work</em></p>
<p>TODO: why didn&rsquo;t it work?</p>
<p><strong>Unstable station name</strong></p>
<p>This schema drift also affected station names. To be a useful ID, we need
names to point to one unique station and unique stations to point to one name.</p>
<p>TODO: 2x2 picture of good and bad set theoretic mappings.</p>
<p><em>All &ldquo;similar&rdquo; stations should point to one unique station name.</em></p>
<p>Barring changes in spelling or extra characters, there were stations where the
cross-streets were renamed.</p>
<p>TODO: picture of this violation</p>
<p><em>All &ldquo;similar&rdquo; station names should point to one unique station.</em></p>
<p>TODO: picture of this broken for name -&gt; id</p>
<p>TODO: picture of this broken for name -&gt; location</p>
<p><strong>Unstable start and endpoints</strong></p>
<p>Since the data had moved from a normalized to a denormalized format, maybe the
actual lat/long locations could serve as primary keys to identify stations? After
the issues with the names and id colums, this was worth verifying.</p>
<p>TODO: Picture of how dispersed multiple nearby blobs can be</p>
<p>TOOD: Picture of how dispersed outliers can be.</p>
<p>I have to conclude that these points actually represent user locations when
they start/stop trips on their smartphone apps. The drift represents a combination
of GPS uncertainty among tall downtown buildings, and physical user displacement
from the actual station when they interact with the app.</p>
<p><strong>Resolution with GBFS</strong></p>
<p>As a last resort, I looked at and decided to merge the live GBFS feed. This
dataset is intended for app developers, and shows real-time station availability
and such. The problem is it&rsquo;s live and doesn&rsquo;t span the entire historical data range.
Given the schema drift issues presented above, I had no confidence the data was
merge-able with anything but 2024 data. But since I only strictly need 2024 data for
the models I plan to run, this limitation is acceptable.</p>
<h3 id="socrata-to-data-frames">Socrata to Data Frames</h3>
<p>As far as I could tell, the Socrata SoQL API returned all data as lists of lists of strings. Since I was making a lot of Socrata calls, I extended the Socrata client like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sodapy <span style="color:#f92672">import</span> Socrata
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ChiClient</span>(Socrata):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, timeout: int):
</span></span><span style="display:flex;"><span>        super()<span style="color:#f92672">.</span>__init__(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;data.cityofchicago.org&#34;</span>, 
</span></span><span style="display:flex;"><span>            app_token<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>            timeout<span style="color:#f92672">=</span>timeout)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self, 
</span></span><span style="display:flex;"><span>            resource_id: str, 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">**</span>params) <span style="color:#f92672">-&gt;</span> pd<span style="color:#f92672">.</span>DataFrame:
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Collects Socrata response into data frame.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>get(resource_id, <span style="color:#f92672">**</span>params)
</span></span><span style="display:flex;"><span>        df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame<span style="color:#f92672">.</span>from_records(data)
</span></span><span style="display:flex;"><span>        df <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>fix_coltypes(df, resource_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fix_coltypes</span>(self, df: pd<span style="color:#f92672">.</span>DataFrame, resource_id: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Coerce string data into other dtypes&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_coltypes(resource_id)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> col <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> coltypes<span style="color:#f92672">.</span>keys():
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Column was transformed e.g. SELECT COUNT(col)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># or renamed e.g. SELECT col AS alias</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> coltypes[col] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;calendar_date&#39;</span>:
</span></span><span style="display:flex;"><span>                df[col] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(df[col])
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> coltypes[col] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;number&#39;</span>:
</span></span><span style="display:flex;"><span>                df[col] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_numeric(df[col])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_coltypes</span>(self, resource_id: str):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;Query basic table metadata&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        meta <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_metadata(resource_id)
</span></span><span style="display:flex;"><span>        colnames <span style="color:#f92672">=</span> [c[<span style="color:#e6db74">&#39;fieldName&#39;</span>] <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> meta[<span style="color:#e6db74">&#39;columns&#39;</span>]]
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#f92672">=</span> [c[<span style="color:#e6db74">&#39;dataTypeName&#39;</span>] <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> meta[<span style="color:#e6db74">&#39;columns&#39;</span>]]
</span></span><span style="display:flex;"><span>        coltypes <span style="color:#f92672">=</span> {c: ct <span style="color:#66d9ef">for</span> c,ct <span style="color:#f92672">in</span> zip(colnames, coltypes)}
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> coltypes
</span></span></code></pre></div><p>Usage comparison:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>In [1]: client = Socrata(&#34;data.cityofchicago.org&#34;, app_token=None, timeout=60)
</span></span><span style="display:flex;"><span>In [2]: chi_client = ChiClient(60)
</span></span><span style="display:flex;"><span>In [3]: TOTAL_RIDERSHIP_TABLE = &#34;6iiy-9s97&#34;
</span></span><span style="display:flex;"><span>In [4]: print(&#34;Original response:&#34;)
</span></span><span style="display:flex;"><span>Original response:
</span></span><span style="display:flex;"><span>In [5]: print(client.get(TOTAL_RIDERSHIP_TABLE, limit=5))
</span></span><span style="display:flex;"><span>[{&#39;service_date&#39;: &#39;2001-01-01T00:00:00.000&#39;, &#39;day_type&#39;: &#39;U&#39;, &#39;bus&#39;: &#39;297192&#39;, &#39;rail_boardings&#39;: &#39;126455&#39;, &#39;total_rides&#39;: &#39;423647&#39;}, {&#39;service_date&#39;: &#39;2001-01-02T00:00:00.000&#39;, &#39;day_type&#39;: &#39;W&#39;, &#39;bus&#39;: &#39;780827&#39;, &#39;rail_boardings&#39;: &#39;501952&#39;, &#39;total_rides&#39;: &#39;1282779&#39;}, {&#39;service_date&#39;: &#39;2001-01-03T00:00:00.000&#39;, &#39;day_type&#39;: &#39;W&#39;, &#39;bus&#39;: &#39;824923&#39;, &#39;rail_boardings&#39;: &#39;536432&#39;, &#39;total_rides&#39;: &#39;1361355&#39;}, {&#39;service_date&#39;: &#39;2001-01-04T00:00:00.000&#39;, &#39;day_type&#39;: &#39;W&#39;, &#39;bus&#39;: &#39;870021&#39;, &#39;rail_boardings&#39;: &#39;550011&#39;, &#39;total_rides&#39;: &#39;1420032&#39;}, {&#39;service_date&#39;: &#39;2001-01-05T00:00:00.000&#39;, &#39;day_type&#39;: &#39;W&#39;, &#39;bus&#39;: &#39;890426&#39;, &#39;rail_boardings&#39;: &#39;557917&#39;, &#39;total_rides&#39;: &#39;1448343&#39;}]
</span></span><span style="display:flex;"><span>In [6]: print(&#34;DataFrame response:&#34;)
</span></span><span style="display:flex;"><span>DataFrame response:
</span></span><span style="display:flex;"><span>In [7]: print(chi_client.get(TOTAL_RIDERSHIP_TABLE, limit=5))
</span></span><span style="display:flex;"><span>  service_date day_type     bus  rail_boardings  total_rides
</span></span><span style="display:flex;"><span>0   2001-01-01        U  297192          126455       423647
</span></span><span style="display:flex;"><span>1   2001-01-02        W  780827          501952      1282779
</span></span><span style="display:flex;"><span>2   2001-01-03        W  824923          536432      1361355
</span></span><span style="display:flex;"><span>3   2001-01-04        W  870021          550011      1420032
</span></span><span style="display:flex;"><span>4   2001-01-05        W  890426          557917      1448343
</span></span></code></pre></div>
    
    <ul class="tags">
    
</ul>

  </div>
</section>

    <section><span style="color: #999999;">Nifty <a href="https://codepen.io/wbeeftink/pen/dIaDH">tech tag lists</a> fromÂ <a class="pen-owner-link" href="https://codepen.io/wbeeftink">Wouter Beeftink</a> </span>
      
    </section>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.6.4.slim.min.js" integrity="sha256-a2yjHM4jnF9f54xUQakjZGaqYs/V1CYvWpoqZzC2/Bw=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  
  <script src="https://unpkg.com/smoothscroll-polyfill@0.4.4/dist/smoothscroll.min.js" integrity="sha384-EYn4rWu1DHvYD0sSSSbMEtXQmMl58CFJd897806+RT1jJVYbhuZlZMN6yG9nCyFa" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/smoothscroll-anchor-polyfill@1.3.2/dist/index.min.js" integrity="sha384-EY9NBEHCFbZANmPcTm7CgG8OhsFILy0VBLG85pF6OIpP42NVbZVNsFOc23PYTCkB" crossorigin="anonymous"></script>
  
  <script async src="/js/resume.js"></script>
  

  

  
</body>
</html>
